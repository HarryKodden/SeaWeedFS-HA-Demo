<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume 1 Details - SeaweedFS</title>
    <link rel="stylesheet" href="/seaweedfsstatic/bootstrap/3.3.1/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
            background-color: #f7f9fc;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .panel {
            margin-bottom: 20px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel-heading {
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            padding: 15px;
        }
        .panel-body {
            padding: 15px;
        }
        .stat-value {
            font-weight: bold;
            font-size: 16px;
        }
        .table {
            margin-bottom: 0;
        }
        .progress {
            margin-bottom: 10px;
        }
        .back-link {
            margin-bottom: 20px;
            display: inline-block;
        }
        .volume-info {
            margin-bottom: 20px;
        }
        .raw-api-links {
            margin-top: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .error-message {
            color: #d9534f;
            margin-top: 15px;
            padding: 10px;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            border-radius: 4px;
        }
        .refresh-button {
            margin-top: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-good {
            background-color: #5cb85c;
        }
        .status-warning {
            background-color: #f0ad4e;
        }
        .status-danger {
            background-color: #d9534f;
        }
        .version-info {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
        
        <h1>
            <img src="/seaweedfsstatic/seaweed50x50.png" alt="SeaweedFS Logo"> 
            Volume Server 1
        </h1>
        
        <div class="row volume-info">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <strong>Volume Server Info:</strong> Rack 1, Data Center: DefaultDataCenter
                    <div class="version-info" id="version-info">Loading version information...</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Storage Statistics</h3>
                    </div>
                    <div class="panel-body">
                        <div id="storage-stats">
                            <table class="table table-bordered">
                                <tr>
                                    <td>Max Volume Count:</td>
                                    <td class="stat-value" id="max-volumes">Loading...</td>
                                </tr>
                                <tr>
                                    <td>Current Volume Count:</td>
                                    <td class="stat-value" id="current-volumes">Loading...</td>
                                </tr>
                                <tr>
                                    <td>Free Space:</td>
                                    <td class="stat-value" id="free-space">Loading...</td>
                                </tr>
                                <tr>
                                    <td>Used Space:</td>
                                    <td class="stat-value" id="used-space">Loading...</td>
                                </tr>
                                <tr>
                                    <td>Total Space:</td>
                                    <td class="stat-value" id="total-space">Loading...</td>
                                </tr>
                            </table>
                            
                            <h4>Disk Usage</h4>
                            <div class="progress">
                                <div id="disk-usage-bar" class="progress-bar progress-bar-success" role="progressbar" 
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                    0%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Volume Server Health</h3>
                    </div>
                    <div class="panel-body">
                        <table class="table table-bordered">
                            <tr>
                                <td>Status:</td>
                                <td class="stat-value">
                                    <span class="status-indicator status-good" id="status-indicator"></span>
                                    <span id="status-text">Online</span>
                                </td>
                            </tr>
                            <tr>
                                <td>Data Directory:</td>
                                <td class="stat-value" id="data-dir">Loading...</td>
                            </tr>
                            <tr>
                                <td>Volumes by Status:</td>
                                <td class="stat-value" id="volumes-by-status">Loading...</td>
                            </tr>
                        </table>
                        <button class="btn btn-sm btn-primary refresh-button" onclick="fetchVolumeStatus()">
                            <span class="glyphicon glyphicon-refresh"></span> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Volume List</h3>
                    </div>
                    <div class="panel-body">
                        <div id="volume-list-error" class="error-message" style="display: none;">
                            No volumes found or error retrieving volume data
                        </div>
                        <table class="table table-striped" id="volume-list">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Size</th>
                                    <th>Files</th>
                                    <th>Status</th>
                                    <th>Collection</th>
                                    <th>Server</th>
                                </tr>
                            </thead>
                            <tbody id="volume-list-body">
                                <tr>
                                    <td colspan="6" class="text-center">Loading volume data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="raw-api-links">
            <h4>API Links:</h4>
            <ul>
                <li><a href="/volume/1/status" target="_blank">/volume/1/status</a> - Volume Server Status</li>
                <li><a href="/volume/1/ui/index.html" target="_blank">/volume/1/ui/index.html</a> - Native Volume UI</li>
                <li><a href="/master/1/dir/status" target="_blank">/master/1/dir/status</a> - Master Directory Status (with volume information)</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Helper function to format bytes into human-readable size
        function formatSize(bytes) {
            if (bytes === 0 || isNaN(bytes)) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Function to fetch volume server status
        async function fetchVolumeStatus() {
            try {
                // Fetch volume server status
                const statusResponse = await fetch('/volume/1/status');
                if (!statusResponse.ok) {
                    throw new Error(`HTTP error! status: ${statusResponse.status}`);
                }
                const statusData = await statusResponse.json();
                
                // Fetch master directory status for volume information
                const masterResponse = await fetch('/master/1/dir/status');
                if (!masterResponse.ok) {
                    throw new Error(`HTTP error! status: ${masterResponse.status}`);
                }
                const masterData = await masterResponse.json();
                
                // Update version information
                if (statusData.Version) {
                    document.getElementById('version-info').innerText = `Version: ${statusData.Version}`;
                }
                
                // Find volume1 in the master data
                let volumeNode = null;
                const dataCenters = masterData.Topology?.DataCenters || [];
                for (const dc of dataCenters) {
                    for (const rack of dc.Racks || []) {
                        for (const node of rack.DataNodes || []) {
                            if (node.Url.startsWith('volume1:')) {
                                volumeNode = node;
                                break;
                            }
                        }
                        if (volumeNode) break;
                    }
                    if (volumeNode) break;
                }
                
                // Update storage stats from disk statuses
                if (statusData.DiskStatuses && statusData.DiskStatuses.length > 0) {
                    const diskStatus = statusData.DiskStatuses[0];
                    
                    // Update disk space information
                    document.getElementById('free-space').innerText = formatSize(diskStatus.free);
                    document.getElementById('used-space').innerText = formatSize(diskStatus.used);
                    document.getElementById('total-space').innerText = formatSize(diskStatus.all);
                    document.getElementById('data-dir').innerText = diskStatus.dir;
                    
                    // Update disk usage bar
                    const usagePercent = Math.round(diskStatus.percent_used);
                    const diskUsageBar = document.getElementById('disk-usage-bar');
                    diskUsageBar.style.width = usagePercent + '%';
                    diskUsageBar.innerText = usagePercent + '%';
                    diskUsageBar.setAttribute('aria-valuenow', usagePercent);
                    
                    // Set appropriate color based on usage
                    if (usagePercent < 70) {
                        diskUsageBar.className = 'progress-bar progress-bar-success';
                    } else if (usagePercent < 90) {
                        diskUsageBar.className = 'progress-bar progress-bar-warning';
                    } else {
                        diskUsageBar.className = 'progress-bar progress-bar-danger';
                    }
                }
                
                // Update volume information from master data
                if (volumeNode) {
                    document.getElementById('max-volumes').innerText = volumeNode.Max || 0;
                    document.getElementById('current-volumes').innerText = volumeNode.Volumes || 0;
                    
                    // Update volumes by status
                    const volumeStatus = 'All volumes are ' + (volumeNode.Volumes > 0 ? 'active' : 'unused');
                    document.getElementById('volumes-by-status').innerText = volumeStatus;
                    
                    // Parse and display volume IDs if available
                    const volumeIds = (volumeNode.VolumeIds || "").trim();
                    const volumeList = document.getElementById('volume-list-body');
                    
                    if (volumeIds && volumeIds !== " ") {
                        const ids = volumeIds.split(',').map(id => id.trim()).filter(id => id);
                        
                        if (ids.length > 0) {
                            let volumeListHTML = '';
                            ids.forEach(id => {
                                volumeListHTML += `
                                <tr>
                                    <td>${id}</td>
                                    <td>~1 GB</td>
                                    <td>-</td>
                                    <td>Active</td>
                                    <td>Default</td>
                                    <td>volume1:8080</td>
                                </tr>`;
                            });
                            volumeList.innerHTML = volumeListHTML;
                            document.getElementById('volume-list-error').style.display = 'none';
                        } else {
                            volumeList.innerHTML = '<tr><td colspan="6" class="text-center">No volumes currently assigned</td></tr>';
                        }
                    } else {
                        volumeList.innerHTML = '<tr><td colspan="6" class="text-center">No volumes currently assigned</td></tr>';
                    }
                } else {
                    // If volume node not found in master data
                    document.getElementById('max-volumes').innerText = '5';
                    document.getElementById('current-volumes').innerText = '0';
                    document.getElementById('volumes-by-status').innerText = 'No volumes assigned';
                    document.getElementById('volume-list-body').innerHTML = 
                        '<tr><td colspan="6" class="text-center">No volumes currently assigned</td></tr>';
                }
                
                // Update status indicator
                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.className = 'status-indicator status-good';
                document.getElementById('status-text').innerText = 'Online';
                
            } catch (error) {
                console.error('Error fetching volume data:', error);
                
                // Show error state
                document.getElementById('status-indicator').className = 'status-indicator status-danger';
                document.getElementById('status-text').innerText = 'Error';
                document.getElementById('volume-list-error').style.display = 'block';
                document.getElementById('volume-list-error').innerText = 'Error fetching volume data: ' + error.message;
            }
        }
        
        // Call once on page load
        fetchVolumeStatus();
        
        // Then refresh every 30 seconds
        setInterval(fetchVolumeStatus, 30000);
    </script>
</body>
</html>
